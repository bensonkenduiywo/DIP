<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Crop mapping</title>

<script src="site_libs/header-attrs-2.8/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Digital Image Processing in R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-gear"></span>
     
    More
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lesson1.html">Data storage schema</a>
    </li>
    <li>
      <a href="fusion.html">Image Fusion</a>
    </li>
    <li>
      <a href="mapping.html">Crop mapping</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:bensonkemboi@gmail.com">
    <span class="fas fa-envelope fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://github.com/bensonkenduiywo">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/bensonkenduiywo">
    <span class="fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/benson-kenduiywo-1a218137">
    <span class="fab fa-linkedin fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Crop mapping</h1>

</div>


<div id="background" class="section level2">
<h2>Background</h2>
<p>Information on spatial distribution of crops is an important step towards yield estimation. We need to know where the crops are before we estimate the yield in a given region. Ground mapping approaches like surveying are expensive and time intensive. Remote sensing offers an effective and efficient platform for mapping thanks to improved temporal and spatial resolutions. In this case we supplement optical data with UAV images for training sites collection, and image fusion for crop mapping.</p>
<p>For crop mapping we use two different classification algorithms:</p>
<ol style="list-style-type: decimal">
<li>Random Forests (RF) by <a href="https://link.springer.com/article/10.1023/A:1010933404324">Breiman 2001</a>.</li>
<li>Maximum Likelihood Classification (MLC).</li>
</ol>
</div>
<div id="data-preparation" class="section level2">
<h2>Data preparation</h2>
<p>Load libraries, declare variables and data paths.</p>
<pre class="r"><code>rm(list=ls(all=TRUE))    #Clears R memory
unlink(&quot;.RData&quot;) 
if (!require(&quot;pacman&quot;)) install.packages(&quot;pacman&quot;); library(pacman)
p_load(raster, terra, randomForest, RStoolbox, tictoc)

options(warn=1)
cat(&quot;Set variables and start processing\n&quot;)</code></pre>
<pre><code>## Set variables and start processing</code></pre>
<pre class="r"><code>Root        &lt;- &#39;D:/JKUAT/RESEARCH_Projects/Eswatini/Data/&#39;
Path_out    &lt;- paste0(Root,&quot;Output/&quot;)</code></pre>
<p>Load Mpolonjeni UAV images for mission 1–5 and Sentinel 2. We will mosaic the UAV images to one image at 1 m spatial resolution and save to disk later. Once this is done we skip this process every other time we run the script.</p>
<pre class="r"><code>#Sentinel 2
path &lt;- list.files(paste0(Root,&#39;S2/interim/&#39;),pattern = (&quot;.tif$&quot;), recursive = TRUE, full.names = TRUE)
s &lt;- rast(path)
names(s) &lt;- c(&quot;b&quot;, &quot;g&quot;,&quot;r&quot;, &quot;nir&quot;)
s</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 10980, 10980, 4  (nrow, ncol, nlyr)
## resolution  : 10, 10  (x, y)
## extent      : 3e+05, 409800, 6990220, 7100020  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=utm +zone=36 +south +datum=WGS84 +units=m +no_defs 
## sources     : RT_T36JUR_20210418T073611_B02.tif  
##               RT_T36JUR_20210418T073611_B03.tif  
##               RT_T36JUR_20210418T073611_B04.tif  
##               ... and 1 more source(s)
## names       : b, g, r, nir</code></pre>
<pre class="r"><code>#UAV
mosaicname &lt;- paste0(Path_out,&#39;Mpolonjeni_W1_Mosaic.tif&#39;)
if(!file.exists(mosaicname)){
folders &lt;- list.dirs(paste0(Root,&#39;WingtraOne/Mpolonjeni&#39;),recursive=TRUE)[-1]
folders 
for (i in 1:length(folders)) {
  path &lt;- list.files(folders[i], pattern = (&quot;.tif$&quot;))
  # Remove all before and up to &quot;reflectance_&quot; in gsub
  path &lt;- path[order(gsub(&quot;.*reflectance_&quot;,&quot;&quot;,path))][-4]
  #reorder the bands to match those in S2
  paths &lt;- path
  paths[3] &lt;- path[4]
  paths[4] &lt;- path[3]
  temp &lt;- rast(paste0(folders[i],&quot;/&quot;,paths))
  names(temp) &lt;- c(&quot;b&quot;, &quot;g&quot;, &quot;r&quot;, &quot;nir&quot;)
  assign(paste0(&quot;v&quot;, i), temp) 
}
}else{
  v &lt;- rast(mosaicname)
}</code></pre>
<p>We now have all the image missions loaded from corresponding sub-folders, stacked, and dynamically allocated variables i.e. <span class="math inline">\(\text{v1},\text{v2},\dots,\text{v5}\)</span>. Resample all the images to 1 m spatial resolution using bilinear approach and mosaic them.</p>
<pre class="r"><code>if(!file.exists(mosaicname)){
  temp &lt;- aggregate(v1[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v1 &lt;- resample(v1, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v2[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v2 &lt;- resample(v2, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v3[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v3 &lt;- resample(v3, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v4[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v4 &lt;- resample(v4, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v5[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v5 &lt;- resample(v5, temp, method=&#39;bilinear&#39;)
}</code></pre>
<p>Let’s now mosaic the scenes to form one image. We will use median to average out the overlaps. Median is preferred because it has been shown to be robust to outliers compared to the mean.</p>
<pre class="r"><code>if(!file.exists(mosaicname)){
  v &lt;- mosaic(v1, v2, v3, v4, v5, fun=&quot;median&quot;)
}</code></pre>
<p>Save the mosaic to disk.</p>
<pre class="r"><code>mosaicname &lt;- paste0(Path_out,&#39;Mpolonjeni_W1_Mosaic.tif&#39;)
if(!file.exists(mosaicname)){
  writeRaster(v, mosaicname)    
}</code></pre>
<p>Crop/clip Sentinel 2 image to UAV image extents.</p>
<pre class="r"><code>s &lt;- crop(s, ext(v), snap=&quot;near&quot;)</code></pre>
<p>Display the images side by side.</p>
<pre class="r"><code>x11()
par(mfrow = c(1, 2)) #c(bottom, left, top, right)
plotRGB(s, r=&quot;nir&quot;, g=&quot;r&quot;, b=&quot;g&quot;, stretch=&quot;lin&quot;, axes=T, mar = c(4, 5, 1.4, 0.2), main=&quot;S2&quot;, cex.axis=0.5)
box()
plotRGB(v, r=&quot;nir&quot;, g=&quot;r&quot;, b=&quot;g&quot;, stretch=&quot;lin&quot;, axes=T, mar = c(4, 5, 1.4, 0.2), main=&quot;UAV&quot;, cex.axis=0.5)
box()</code></pre>
<p><img src="mapping_files/figure-html/d7-1.png" width="672" /></p>
</div>
<div id="training-data-sampling" class="section level2">
<h2>Training data sampling</h2>
<p>Load train data.</p>
<pre class="r"><code>#ref &lt;- vect(paste0(Root,&#39;Vector/Training_Sites_Mpolonjeni.shp&#39;), &quot;polygons&quot;)
ref  &lt;- shapefile(paste0(Root,&#39;Vector/Training_Sites_Mpolonjeni.shp&#39;))
ref &lt;- spTransform(ref, crs(v))</code></pre>
<p>Sample points from the polygons (stratified random sampling).</p>
<pre class="r"><code>set.seed(530)
samp &lt;- spsample(ref, 4000, type=&#39;stratified&#39;)</code></pre>
<pre><code>## Warning in proj4string(obj): CRS object has comment, which is lost in output</code></pre>
<pre class="r"><code># add the land cover class to the points
samp$class &lt;- over(samp, ref)$Name
samp$code &lt;- over(samp, ref)$code
knitr::kable(table(samp$class), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Var1</th>
<th align="left">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">built_up</td>
<td align="left">734</td>
</tr>
<tr class="even">
<td align="left">cassava</td>
<td align="left">109</td>
</tr>
<tr class="odd">
<td align="left">grass</td>
<td align="left">132</td>
</tr>
<tr class="even">
<td align="left">maize</td>
<td align="left">749</td>
</tr>
<tr class="odd">
<td align="left">sorghum</td>
<td align="left">235</td>
</tr>
<tr class="even">
<td align="left">sweet_potato</td>
<td align="left">738</td>
</tr>
<tr class="odd">
<td align="left">trees</td>
<td align="left">918</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">368</td>
</tr>
</tbody>
</table>
<pre class="r"><code>sum(table(samp$class))</code></pre>
<pre><code>## [1] 3983</code></pre>
<p>Declare the class names and their number.</p>
<pre class="r"><code>#samp &lt;- spTransform(samp, crs(v))
nClasses &lt;- 8
Classes &lt;- data.frame(classID=c(1:8),class=c(&#39;Built_up&#39;,&#39;Cassava&#39;, &#39;Grass&#39;,  &#39;Maize&#39;,  &#39;Sorghum&#39;, &#39;Sweet_potato&#39;,&#39;Trees&#39;,&#39;Water&#39;))</code></pre>
<p>Display S2 image and the training points.</p>
<pre class="r"><code>add_legend &lt;- function(...) {
  opar &lt;- par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), 
    mar=c(0, 0, 0, 0), new=TRUE)
  on.exit(par(opar))
  plot(0, 0, type=&#39;n&#39;, bty=&#39;n&#39;, xaxt=&#39;n&#39;, yaxt=&#39;n&#39;)
  legend(...)
}

x11()
#par(mar = c(4, 4, 1.4, 0.1)) #c(bottom, left, top, right)
plotRGB(s, r=&quot;nir&quot;, g=&quot;r&quot;, b=&quot;g&quot;, stretch=&quot;lin&quot;, axes = TRUE, mar = c(4, 5, 1.4, 0.1))
#points(samp, col=&quot;blue&quot;, cex=.5)
lines(spTransform(ref, crs(s)), col=&quot;blue&quot;, lwd=1.5)
add_legend(&quot;bottom&quot;, legend=&quot;Reference data&quot;, 
pch=c(0,15), col=&quot;blue&quot;, horiz=T, bty=&#39;n&#39;, cex=1.1)</code></pre>
<p><img src="mapping_files/figure-html/v4-1.png" width="672" /></p>
<p>Extract UAV and S2 pixels values overlaid by points and split them into training and validation points.</p>
<pre class="r"><code>#library(spatialEco) 
trainData.v &lt;- extract(brick(v), samp, cellnumbers=F, df=T, sp=T)
knitr::kable(head(trainData.v))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">class</th>
<th align="right">code</th>
<th align="right">b</th>
<th align="right">g</th>
<th align="right">r</th>
<th align="right">nir</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0643933</td>
<td align="right">0.0971735</td>
<td align="right">0.1009569</td>
<td align="right">0.0849024</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0642581</td>
<td align="right">0.0969432</td>
<td align="right">0.1003542</td>
<td align="right">0.0865044</td>
</tr>
<tr class="odd">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0645692</td>
<td align="right">0.0981981</td>
<td align="right">0.1022022</td>
<td align="right">0.0864920</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0633345</td>
<td align="right">0.0975087</td>
<td align="right">0.0983355</td>
<td align="right">0.0855006</td>
</tr>
<tr class="odd">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0642581</td>
<td align="right">0.0969432</td>
<td align="right">0.1003542</td>
<td align="right">0.0865044</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0642581</td>
<td align="right">0.0969432</td>
<td align="right">0.1003542</td>
<td align="right">0.0865044</td>
</tr>
</tbody>
</table>
<pre class="r"><code>trainData.s &lt;- extract(brick(s), samp, cellnumbers=F, df=T, sp=T)
knitr::kable(head(trainData.s))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">class</th>
<th align="right">code</th>
<th align="right">b</th>
<th align="right">g</th>
<th align="right">r</th>
<th align="right">nir</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0228</td>
<td align="right">0.0253</td>
<td align="right">0.024</td>
<td align="right">0.0227</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0228</td>
<td align="right">0.0253</td>
<td align="right">0.024</td>
<td align="right">0.0227</td>
</tr>
<tr class="odd">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0228</td>
<td align="right">0.0253</td>
<td align="right">0.024</td>
<td align="right">0.0227</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0228</td>
<td align="right">0.0253</td>
<td align="right">0.024</td>
<td align="right">0.0227</td>
</tr>
<tr class="odd">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0228</td>
<td align="right">0.0253</td>
<td align="right">0.024</td>
<td align="right">0.0227</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="right">8</td>
<td align="right">0.0228</td>
<td align="right">0.0253</td>
<td align="right">0.024</td>
<td align="right">0.0227</td>
</tr>
</tbody>
</table>
<pre class="r"><code>library(caTools)
#(NB: 0.4 means 40% for training and 60% for validation)
labels &lt;- as.data.frame(trainData.v[,1])
split &lt;- sample.split(labels, SplitRatio = 0.4)
#UAV
valid.v &lt;- subset(trainData.v, split == FALSE) 
train.v &lt;- subset(trainData.v, split == TRUE) 
knitr::kable(table(train.v$class), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Var1</th>
<th align="left">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">built_up</td>
<td align="left">248</td>
</tr>
<tr class="even">
<td align="left">cassava</td>
<td align="left">38</td>
</tr>
<tr class="odd">
<td align="left">grass</td>
<td align="left">43</td>
</tr>
<tr class="even">
<td align="left">maize</td>
<td align="left">246</td>
</tr>
<tr class="odd">
<td align="left">sorghum</td>
<td align="left">77</td>
</tr>
<tr class="even">
<td align="left">sweet_potato</td>
<td align="left">246</td>
</tr>
<tr class="odd">
<td align="left">trees</td>
<td align="left">307</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">122</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(table(valid.v$class), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Var1</th>
<th align="left">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">built_up</td>
<td align="left">486</td>
</tr>
<tr class="even">
<td align="left">cassava</td>
<td align="left">71</td>
</tr>
<tr class="odd">
<td align="left">grass</td>
<td align="left">89</td>
</tr>
<tr class="even">
<td align="left">maize</td>
<td align="left">503</td>
</tr>
<tr class="odd">
<td align="left">sorghum</td>
<td align="left">158</td>
</tr>
<tr class="even">
<td align="left">sweet_potato</td>
<td align="left">492</td>
</tr>
<tr class="odd">
<td align="left">trees</td>
<td align="left">611</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">246</td>
</tr>
</tbody>
</table>
<pre class="r"><code>#Sentinel 2
valid.s &lt;- subset(trainData.s, split == FALSE) 
train.s &lt;- subset(trainData.s, split == TRUE) 
knitr::kable(table(train.s$class), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Var1</th>
<th align="left">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">built_up</td>
<td align="left">248</td>
</tr>
<tr class="even">
<td align="left">cassava</td>
<td align="left">38</td>
</tr>
<tr class="odd">
<td align="left">grass</td>
<td align="left">43</td>
</tr>
<tr class="even">
<td align="left">maize</td>
<td align="left">246</td>
</tr>
<tr class="odd">
<td align="left">sorghum</td>
<td align="left">77</td>
</tr>
<tr class="even">
<td align="left">sweet_potato</td>
<td align="left">246</td>
</tr>
<tr class="odd">
<td align="left">trees</td>
<td align="left">307</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">122</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(table(valid.s$class), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Var1</th>
<th align="left">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">built_up</td>
<td align="left">486</td>
</tr>
<tr class="even">
<td align="left">cassava</td>
<td align="left">71</td>
</tr>
<tr class="odd">
<td align="left">grass</td>
<td align="left">89</td>
</tr>
<tr class="even">
<td align="left">maize</td>
<td align="left">503</td>
</tr>
<tr class="odd">
<td align="left">sorghum</td>
<td align="left">158</td>
</tr>
<tr class="even">
<td align="left">sweet_potato</td>
<td align="left">492</td>
</tr>
<tr class="odd">
<td align="left">trees</td>
<td align="left">611</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">246</td>
</tr>
</tbody>
</table>
</div>
<div id="maximum-likelihood-classification" class="section level2">
<h2>Maximum Likelihood Classification</h2>
<p>Classify UAV and S2 image using MLC algorithm.</p>
<pre class="r"><code>#UAV classification
mlc.uav &lt;- superClass(brick(v), train.v[-2], responseCol = &quot;class&quot;,
                model = &quot;mlc&quot;, minDist = 1)
val.uav &lt;- validateMap(mlc.uav$map, valid.v[-2], responseCol=&quot;class&quot;, mode=&#39;classification&#39;, 
classMapping = mlc.uav$classMapping)
#Sentinel 2 classification
mlc.s &lt;- superClass(brick(s), train.s, responseCol = &quot;class&quot;,
                model = &quot;mlc&quot;, minDist = 1)
val.s &lt;- validateMap(mlc.s$map, valid.s, responseCol=&quot;class&quot;, mode=&#39;classification&#39;, 
classMapping = mlc.s$classMapping)</code></pre>
<p>Make a function to display classified images and use it to display the MLC map.</p>
<pre class="r"><code>display &lt;- function(map, method, nClasses){
    x11()
    par(mar = c(7, 2, 1.6, 6)) #c(bottom, left, top, right)
    image(map, col=c(&quot;red&quot;, &quot;orange&quot;, &quot;cyan&quot; , &quot;yellow&quot;, &quot;brown&quot;, &quot;magenta&quot;, &quot;green1&quot;,&quot;blue&quot;), axes=T, ann=F)
    classes.Palette &lt;- colorRampPalette(c(&quot;red&quot;, &quot;orange&quot;, &quot;cyan&quot; , &quot;yellow&quot;, &quot;brown&quot;, &quot;magenta&quot;, &quot;green1&quot;,&quot;blue&quot;, &quot;white&quot;)) 
    add_legend(&quot;bottom&quot;, legend=c(&#39;Built_up&#39;,&#39;Cassava&#39;, &#39;Grass&#39;, 
&#39;Maize&#39;,  &#39;Sorghum&#39;, &#39;Sweet_potato&#39;,&#39;Trees&#39;,&#39;Water&#39;, &quot;No data&quot;), fill=classes.Palette(nClasses+1), ncol=3, bty=&#39;n&#39;, cex=1.1,  pt.bg = NA)
    title(paste0(method,&quot; Classification&quot;))
}
display(mlc.uav$map, &quot;UAV MLC&quot;, nClasses)
display(mlc.s$map, &quot;S2 MLC&quot;, nClasses)</code></pre>
<p>Lets design a function for accuracy assessment.</p>
<pre class="r"><code>accuracy &lt;- function(val.test){
    assessment.storage &lt;- val.test$performance 
    #print(assessment.storage)
    list_of_datasets &lt;- list(&quot;ConfusionMatrix&quot; = as.matrix(assessment.storage$table), 
                    &quot;OverallAcc&quot; = as.matrix(assessment.storage$overall), 
                    &quot;byClass&quot; = as.matrix(assessment.storage$byClass))
    return(list_of_datasets)
}</code></pre>
<p>Assess the accuracy of MLC.</p>
<pre class="r"><code>print(&#39;UAV Confusion matrixs&#39;)</code></pre>
<pre><code>## [1] &quot;UAV Confusion matrixs&quot;</code></pre>
<pre class="r"><code>List.v &lt;- accuracy(val.uav)
knitr::kable(List.v$ConfusionMatrix,align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">built_up</th>
<th align="left">cassava</th>
<th align="left">grass</th>
<th align="left">maize</th>
<th align="left">sorghum</th>
<th align="left">sweet_potato</th>
<th align="left">trees</th>
<th align="left">waterbody</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">built_up</td>
<td align="left">268</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">cassava</td>
<td align="left">0</td>
<td align="left">39</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">grass</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">56</td>
<td align="left">22</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">5</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">maize</td>
<td align="left">13</td>
<td align="left">0</td>
<td align="left">2</td>
<td align="left">233</td>
<td align="left">6</td>
<td align="left">0</td>
<td align="left">6</td>
<td align="left">4</td>
</tr>
<tr class="odd">
<td align="left">sorghum</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">5</td>
<td align="left">70</td>
<td align="left">0</td>
<td align="left">3</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">sweet_potato</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">239</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">trees</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">2</td>
<td align="left">3</td>
<td align="left">1</td>
<td align="left">2</td>
<td align="left">352</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">109</td>
</tr>
</tbody>
</table>
<pre class="r"><code>print(&#39;S2 Confusion matrixs&#39;)</code></pre>
<pre><code>## [1] &quot;S2 Confusion matrixs&quot;</code></pre>
<pre class="r"><code>List.s &lt;- accuracy(val.s)
knitr::kable(List.s$ConfusionMatrix,align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">built_up</th>
<th align="left">cassava</th>
<th align="left">grass</th>
<th align="left">maize</th>
<th align="left">sorghum</th>
<th align="left">sweet_potato</th>
<th align="left">trees</th>
<th align="left">waterbody</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">built_up</td>
<td align="left">67</td>
<td align="left">0</td>
<td align="left">2</td>
<td align="left">2</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">2</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">cassava</td>
<td align="left">0</td>
<td align="left">8</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">grass</td>
<td align="left">3</td>
<td align="left">0</td>
<td align="left">12</td>
<td align="left">5</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">4</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">maize</td>
<td align="left">4</td>
<td align="left">0</td>
<td align="left">8</td>
<td align="left">29</td>
<td align="left">2</td>
<td align="left">0</td>
<td align="left">7</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">sorghum</td>
<td align="left">3</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">4</td>
<td align="left">6</td>
<td align="left">0</td>
<td align="left">5</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">sweet_potato</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">14</td>
<td align="left">3</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">trees</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">112</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">8</td>
</tr>
</tbody>
</table>
<pre class="r"><code>print(&#39;Other accuracy measures&#39;)</code></pre>
<pre><code>## [1] &quot;Other accuracy measures&quot;</code></pre>
<pre class="r"><code>knitr::kable(data.frame(Type=List.v$OverallAcc[,0], UAV=round(List.v$OverallAcc[,1],3),S2=round(List.s$OverallAcc[,1],3)),align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV</th>
<th align="left">S2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Accuracy</td>
<td align="left">0.947</td>
<td align="left">0.818</td>
</tr>
<tr class="even">
<td align="left">Kappa</td>
<td align="left">0.936</td>
<td align="left">0.759</td>
</tr>
<tr class="odd">
<td align="left">AccuracyLower</td>
<td align="left">0.934</td>
<td align="left">0.771</td>
</tr>
<tr class="even">
<td align="left">AccuracyUpper</td>
<td align="left">0.958</td>
<td align="left">0.859</td>
</tr>
<tr class="odd">
<td align="left">AccuracyNull</td>
<td align="left">0.255</td>
<td align="left">0.425</td>
</tr>
<tr class="even">
<td align="left">AccuracyPValue</td>
<td align="left">0.000</td>
<td align="left">0.000</td>
</tr>
<tr class="odd">
<td align="left">McnemarPValue</td>
<td align="left">NaN</td>
<td align="left">NaN</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(data.frame(UAV_F1score=round(List.v$byClass[,&#39;F1&#39;],3),S2_F1score=round(List.s$byClass[,&#39;F1&#39;],3)),align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV_F1score</th>
<th align="left">S2_F1score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: built_up</td>
<td align="left">0.973</td>
<td align="left">0.893</td>
</tr>
<tr class="even">
<td align="left">Class: cassava</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
<tr class="odd">
<td align="left">Class: grass</td>
<td align="left">0.778</td>
<td align="left">0.511</td>
</tr>
<tr class="even">
<td align="left">Class: maize</td>
<td align="left">0.884</td>
<td align="left">0.637</td>
</tr>
<tr class="odd">
<td align="left">Class: sorghum</td>
<td align="left">0.903</td>
<td align="left">0.429</td>
</tr>
<tr class="even">
<td align="left">Class: sweet_potato</td>
<td align="left">0.996</td>
<td align="left">0.903</td>
</tr>
<tr class="odd">
<td align="left">Class: trees</td>
<td align="left">0.968</td>
<td align="left">0.907</td>
</tr>
<tr class="even">
<td align="left">Class: waterbody</td>
<td align="left">0.982</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(data.frame(UAV_UserAcc=round(List.v$byClass[,&#39;Precision&#39;],3),S2_UserAcc=round(List.s$byClass[,&#39;Precision&#39;],3)),align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV_UserAcc</th>
<th align="left">S2_UserAcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: built_up</td>
<td align="left">0.996</td>
<td align="left">0.918</td>
</tr>
<tr class="even">
<td align="left">Class: cassava</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
<tr class="odd">
<td align="left">Class: grass</td>
<td align="left">0.667</td>
<td align="left">0.500</td>
</tr>
<tr class="even">
<td align="left">Class: maize</td>
<td align="left">0.883</td>
<td align="left">0.580</td>
</tr>
<tr class="odd">
<td align="left">Class: sorghum</td>
<td align="left">0.897</td>
<td align="left">0.316</td>
</tr>
<tr class="even">
<td align="left">Class: sweet_potato</td>
<td align="left">1.000</td>
<td align="left">0.824</td>
</tr>
<tr class="odd">
<td align="left">Class: trees</td>
<td align="left">0.978</td>
<td align="left">0.982</td>
</tr>
<tr class="even">
<td align="left">Class: waterbody</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(data.frame(UAV_ProducerAcc=round(List.v$byClass[,&#39;Sensitivity&#39;],3),S2_ProducerAcc=round(List.s$byClass[,&#39;Sensitivity&#39;],3)),align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV_ProducerAcc</th>
<th align="left">S2_ProducerAcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: built_up</td>
<td align="left">0.950</td>
<td align="left">0.870</td>
</tr>
<tr class="even">
<td align="left">Class: cassava</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
<tr class="odd">
<td align="left">Class: grass</td>
<td align="left">0.933</td>
<td align="left">0.522</td>
</tr>
<tr class="even">
<td align="left">Class: maize</td>
<td align="left">0.886</td>
<td align="left">0.707</td>
</tr>
<tr class="odd">
<td align="left">Class: sorghum</td>
<td align="left">0.909</td>
<td align="left">0.667</td>
</tr>
<tr class="even">
<td align="left">Class: sweet_potato</td>
<td align="left">0.992</td>
<td align="left">1.000</td>
</tr>
<tr class="odd">
<td align="left">Class: trees</td>
<td align="left">0.959</td>
<td align="left">0.842</td>
</tr>
<tr class="even">
<td align="left">Class: waterbody</td>
<td align="left">0.965</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
<p>Generally UAV gives better accuracy in most classes except for cassava and maize where Sentinel 2 performs well as observed from F1-score. However, the big question is will fusion improve accuracy? Let’s consider a mean fusion approach using random forest predicted/simulated high Sentinel based donwsampled Sentinel 2 data and UAV.</p>
<p>Downsample S2 to UAV 1 m spatial resolution using bilinear.</p>
<pre class="r"><code>s_r &lt;- resample(s,v,method=&quot;bilinear&quot;)</code></pre>
<p>Now sample points from UAV MLC land-cover RF regression prediction.</p>
<pre class="r"><code>set.seed(530)
points &lt;- spatSample(rast(mlc.uav$map), 3000, &quot;stratified&quot;, as.points=T, na.rm=T, values=F)</code></pre>
<p>Use the stratified randomly sample points to train and predict simulated high resolution S2.</p>
<pre class="r"><code>s2_p &lt;- extract(s_r, points, drop=F)
knitr::kable(head(s2_p), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">ID</th>
<th align="left">b</th>
<th align="left">g</th>
<th align="left">r</th>
<th align="left">nir</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">0.0393197</td>
<td align="left">0.0602216</td>
<td align="left">0.0562606</td>
<td align="left">0.2464113</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">0.0276525</td>
<td align="left">0.0408229</td>
<td align="left">0.0302760</td>
<td align="left">0.2619595</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">0.0280685</td>
<td align="left">0.0393812</td>
<td align="left">0.0301973</td>
<td align="left">0.2556855</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">0.0348108</td>
<td align="left">0.0508313</td>
<td align="left">0.0501398</td>
<td align="left">0.2338444</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">0.0391453</td>
<td align="left">0.0599790</td>
<td align="left">0.0634117</td>
<td align="left">0.2391077</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">0.0391183</td>
<td align="left">0.0577873</td>
<td align="left">0.0638365</td>
<td align="left">0.2426294</td>
</tr>
</tbody>
</table>
<pre class="r"><code>vr_p &lt;- extract(v, points, drop=F)
knitr::kable(head(vr_p), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">ID</th>
<th align="left">b</th>
<th align="left">g</th>
<th align="left">r</th>
<th align="left">nir</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">0.2226881</td>
<td align="left">0.3732991</td>
<td align="left">0.2850645</td>
<td align="left">2.9043691</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">0.0852571</td>
<td align="left">0.1152778</td>
<td align="left">0.0861861</td>
<td align="left">1.2984504</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">0.0484837</td>
<td align="left">0.0587416</td>
<td align="left">0.0480554</td>
<td align="left">0.6412777</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">0.0290400</td>
<td align="left">0.0369230</td>
<td align="left">0.0264030</td>
<td align="left">0.5202775</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">0.0428044</td>
<td align="left">0.0602511</td>
<td align="left">0.0645384</td>
<td align="left">0.4539916</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">0.0479790</td>
<td align="left">0.0618544</td>
<td align="left">0.0807158</td>
<td align="left">0.4839757</td>
</tr>
</tbody>
</table>
<pre class="r"><code>data &lt;- data.frame(S2=s2_p[,-1], UAV=vr_p[,-1])
library(randomForest)
#S2 predicted high resolution output name
s2h_name &lt;- paste0(Path_out,&#39;Mpolonjeni_S2_higres_Prediction.tif&#39;)
if(!file.exists(s2h_name)){
  UAV &lt;- rast(mosaicname)
  names(UAV) &lt;- c(&quot;UAV.b&quot;, &quot;UAV.g&quot;, &quot;UAV.r&quot;, &quot;UAV.nir&quot;)
  startTime &lt;- Sys.time() 
  cat(&quot;Start time&quot;, format(startTime),&quot;\n&quot;)
    s2h.b &lt;- predict(UAV, randomForest(S2.b~UAV.b, data=data, ntree = 300), na.rm=T)
    s2h.g &lt;- predict(UAV, randomForest(S2.g~UAV.g, data=data, ntree = 300), na.rm=T)
    s2h.r &lt;- predict(UAV, randomForest(S2.r~UAV.r, data=data, ntree = 300), na.rm=T)
    s2h.nir &lt;- predict(UAV, randomForest(S2.nir~UAV.nir, data=data, ntree = 300), na.rm=T)
  timeDiff &lt;- Sys.time() - startTime
  cat(&quot;\n Processing time&quot;, format(timeDiff), &quot;\n&quot;)
}</code></pre>
<p>Stack all the S2 bands predictions.</p>
<pre class="r"><code>if(!file.exists(s2h_name)){
  #Stack them
  s2h &lt;- c(s2h.b,s2h.g,s2h.r,s2h.nir)
  names(s2h) &lt;- c(&quot;b&quot;, &quot;g&quot;,&quot;r&quot;, &quot;nir&quot;)
  s2h
  writeRaster(s2h, s2h_name)    
}else{
  s2h &lt;- rast(s2h_name)
}</code></pre>
<p>Fuse the simulated S2 high resolution image with UAV using median.</p>
<pre class="r"><code>s2h.fused &lt;- v
s2h.fused &lt;- mean(s2h, v)
s2h.fused</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 3228, 2572, 4  (nrow, ncol, nlyr)
## resolution  : 1, 1  (x, y)
## extent      : 388657.1, 391229.1, 7070057, 7073285  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=utm +zone=36 +south +datum=WGS84 +units=m +no_defs 
## source      : memory 
## names       :          b,          g,          r,        nir 
## min values  : 0.01521104, 0.02353837, 0.01816200, 0.04858300 
## max values  :  0.6900264,  0.9911296,  1.1898333,  4.2927577</code></pre>
<p>Classify and validate the fused product using MLC.</p>
<pre class="r"><code>trainData.f &lt;- extract(brick(s2h.fused), samp, cellnumbers=F, df=T, sp=T)
knitr::kable(head(trainData.f), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">class</th>
<th align="left">code</th>
<th align="left">b</th>
<th align="left">g</th>
<th align="left">r</th>
<th align="left">nir</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">waterbody</td>
<td align="left">8</td>
<td align="left">0.0528547</td>
<td align="left">0.0758793</td>
<td align="left">0.0783905</td>
<td align="left">0.0715046</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">8</td>
<td align="left">0.0526525</td>
<td align="left">0.0657366</td>
<td align="left">0.0807126</td>
<td align="left">0.0732824</td>
</tr>
<tr class="odd">
<td align="left">waterbody</td>
<td align="left">8</td>
<td align="left">0.0491812</td>
<td align="left">0.0733447</td>
<td align="left">0.0792717</td>
<td align="left">0.0732762</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">8</td>
<td align="left">0.0498265</td>
<td align="left">0.0749694</td>
<td align="left">0.0791994</td>
<td align="left">0.0718037</td>
</tr>
<tr class="odd">
<td align="left">waterbody</td>
<td align="left">8</td>
<td align="left">0.0526525</td>
<td align="left">0.0657366</td>
<td align="left">0.0807126</td>
<td align="left">0.0732824</td>
</tr>
<tr class="even">
<td align="left">waterbody</td>
<td align="left">8</td>
<td align="left">0.0526525</td>
<td align="left">0.0657366</td>
<td align="left">0.0807126</td>
<td align="left">0.0732824</td>
</tr>
</tbody>
</table>
<pre class="r"><code>valid.f &lt;- subset(trainData.f, split == FALSE) 
train.f &lt;- subset(trainData.f, split == TRUE) 

mlc.f &lt;- superClass(brick(s2h.fused), train.f, responseCol = &quot;class&quot;,
                model = &quot;mlc&quot;, minDist = 1)
val.f &lt;- validateMap(mlc.f$map, valid.f, responseCol=&quot;class&quot;, mode=&#39;classification&#39;,  classMapping = mlc.f$classMapping)

display(mlc.f$map, &quot;Fused MLC&quot;, nClasses)</code></pre>
<p>Validate the fused MLC land-cover product.</p>
<pre class="r"><code>List.f &lt;- accuracy(val.f)
print(&#39;Accuracy measures comparison&#39;)</code></pre>
<pre><code>## [1] &quot;Accuracy measures comparison&quot;</code></pre>
<pre class="r"><code>knitr::kable(data.frame(Type=List.v$OverallAcc[,0], UAV=round(List.v$OverallAcc[,1],3),S2=round(List.s$OverallAcc[,1],3),Fused=round(List.f$OverallAcc[,1],3)),align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV</th>
<th align="left">S2</th>
<th align="left">Fused</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Accuracy</td>
<td align="left">0.947</td>
<td align="left">0.818</td>
<td align="left">0.907</td>
</tr>
<tr class="even">
<td align="left">Kappa</td>
<td align="left">0.936</td>
<td align="left">0.759</td>
<td align="left">0.888</td>
</tr>
<tr class="odd">
<td align="left">AccuracyLower</td>
<td align="left">0.934</td>
<td align="left">0.771</td>
<td align="left">0.891</td>
</tr>
<tr class="even">
<td align="left">AccuracyUpper</td>
<td align="left">0.958</td>
<td align="left">0.859</td>
<td align="left">0.922</td>
</tr>
<tr class="odd">
<td align="left">AccuracyNull</td>
<td align="left">0.255</td>
<td align="left">0.425</td>
<td align="left">0.255</td>
</tr>
<tr class="even">
<td align="left">AccuracyPValue</td>
<td align="left">0.000</td>
<td align="left">0.000</td>
<td align="left">0.000</td>
</tr>
<tr class="odd">
<td align="left">McnemarPValue</td>
<td align="left">NaN</td>
<td align="left">NaN</td>
<td align="left">NaN</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(data.frame(UAV_F1score=round(List.v$byClass[,&#39;F1&#39;],3),S2_F1score=round(List.s$byClass[,&#39;F1&#39;],3),Fused_F1score=round(List.f$byClass[,&#39;F1&#39;],3)),align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV_F1score</th>
<th align="left">S2_F1score</th>
<th align="left">Fused_F1score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: built_up</td>
<td align="left">0.973</td>
<td align="left">0.893</td>
<td align="left">0.976</td>
</tr>
<tr class="even">
<td align="left">Class: cassava</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
<td align="left">0.925</td>
</tr>
<tr class="odd">
<td align="left">Class: grass</td>
<td align="left">0.778</td>
<td align="left">0.511</td>
<td align="left">0.750</td>
</tr>
<tr class="even">
<td align="left">Class: maize</td>
<td align="left">0.884</td>
<td align="left">0.637</td>
<td align="left">0.810</td>
</tr>
<tr class="odd">
<td align="left">Class: sorghum</td>
<td align="left">0.903</td>
<td align="left">0.429</td>
<td align="left">0.733</td>
</tr>
<tr class="even">
<td align="left">Class: sweet_potato</td>
<td align="left">0.996</td>
<td align="left">0.903</td>
<td align="left">0.975</td>
</tr>
<tr class="odd">
<td align="left">Class: trees</td>
<td align="left">0.968</td>
<td align="left">0.907</td>
<td align="left">0.922</td>
</tr>
<tr class="even">
<td align="left">Class: waterbody</td>
<td align="left">0.982</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(data.frame(UAV_UserAcc=round(List.v$byClass[,&#39;Precision&#39;],3),S2_UserAcc=round(List.s$byClass[,&#39;Precision&#39;],3),Fused_UserAcc=round(List.f$byClass[,&#39;Precision&#39;],3)),align=&#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV_UserAcc</th>
<th align="left">S2_UserAcc</th>
<th align="left">Fused_UserAcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: built_up</td>
<td align="left">0.996</td>
<td align="left">0.918</td>
<td align="left">0.996</td>
</tr>
<tr class="even">
<td align="left">Class: cassava</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
<td align="left">0.902</td>
</tr>
<tr class="odd">
<td align="left">Class: grass</td>
<td align="left">0.667</td>
<td align="left">0.500</td>
<td align="left">0.643</td>
</tr>
<tr class="even">
<td align="left">Class: maize</td>
<td align="left">0.883</td>
<td align="left">0.580</td>
<td align="left">0.853</td>
</tr>
<tr class="odd">
<td align="left">Class: sorghum</td>
<td align="left">0.897</td>
<td align="left">0.316</td>
<td align="left">0.614</td>
</tr>
<tr class="even">
<td align="left">Class: sweet_potato</td>
<td align="left">1.000</td>
<td align="left">0.824</td>
<td align="left">0.979</td>
</tr>
<tr class="odd">
<td align="left">Class: trees</td>
<td align="left">0.978</td>
<td align="left">0.982</td>
<td align="left">0.956</td>
</tr>
<tr class="even">
<td align="left">Class: waterbody</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
<pre class="r"><code>knitr::kable(data.frame(UAV_ProducerAcc=round(List.v$byClass[,&#39;Sensitivity&#39;],3),S2_ProducerAcc=round(List.s$byClass[,&#39;Sensitivity&#39;],3), Fused_ProducerAcc=round(List.f$byClass[,&#39;Sensitivity&#39;],3)), align = &#39;l&#39;)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">UAV_ProducerAcc</th>
<th align="left">S2_ProducerAcc</th>
<th align="left">Fused_ProducerAcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: built_up</td>
<td align="left">0.950</td>
<td align="left">0.870</td>
<td align="left">0.957</td>
</tr>
<tr class="even">
<td align="left">Class: cassava</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
<td align="left">0.949</td>
</tr>
<tr class="odd">
<td align="left">Class: grass</td>
<td align="left">0.933</td>
<td align="left">0.522</td>
<td align="left">0.900</td>
</tr>
<tr class="even">
<td align="left">Class: maize</td>
<td align="left">0.886</td>
<td align="left">0.707</td>
<td align="left">0.772</td>
</tr>
<tr class="odd">
<td align="left">Class: sorghum</td>
<td align="left">0.909</td>
<td align="left">0.667</td>
<td align="left">0.909</td>
</tr>
<tr class="even">
<td align="left">Class: sweet_potato</td>
<td align="left">0.992</td>
<td align="left">1.000</td>
<td align="left">0.971</td>
</tr>
<tr class="odd">
<td align="left">Class: trees</td>
<td align="left">0.959</td>
<td align="left">0.842</td>
<td align="left">0.891</td>
</tr>
<tr class="even">
<td align="left">Class: waterbody</td>
<td align="left">0.965</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
<p>It is clear that fusion improved mapping accuracy of some crops and was definitely better than S2 classification. Do we probably need a better framework to reap the benefits fo fusion? Lets try another classification method.</p>
<div id="random-forest-rf" class="section level3">
<h3>Random Forest (RF)</h3>
<p>Use RF to classify the images (UAV, S2 and fused image) and compare crop mapping accuracy with MLC. Firsts, we evaluate model training using plots of training error and variable importance. Note: the most important variable is one which has the highest increase in Mean Standard Error (MSE) when removed from the model training samples. We explore these plots using the PCA fused image as an example. From Figure @ref(fig:rf1), the training error reduces with increase in number of trees. We set the number of trees to 250 because it has been established that over 200 trees RF estimates are stable (Hastie, Tibshirani, and Friedman 2011).</p>
<pre class="r"><code>rf.pca &lt;- randomForest(code~., data=na.omit(as.data.frame(train.f[,-1]@data)), ntree = 250, importance=T)
plot(rf.pca, main=&#39;RF Training Error&#39;)</code></pre>
<div class="figure">
<img src="mapping_files/figure-html/rf1-1.png" alt="F Training Error w.r.t number of trees." width="672" />
<p class="caption">
F Training Error w.r.t number of trees.
</p>
</div>
<pre class="r"><code>#knitr::kable(importance(rf.pca))</code></pre>
<pre class="r"><code>varImpPlot(rf.pca,sort=TRUE, n.var=min(dim(s2h.fused)[3], nrow(rf.pca$importance)), type = 1)</code></pre>
<div class="figure">
<img src="mapping_files/figure-html/rf2-1.png" alt="RF Variable importance b ased on mean decrease in MSE." width="672" />
<p class="caption">
RF Variable importance b ased on mean decrease in MSE.
</p>
</div>
<p>Mean Decrease Gini (IncNodePurity) - This is a measure of variable importance based on the Gini impurity index (i.e. node purity) used for the calculating the splits in trees. The higher the value of mean decrease accuracy or mean decrease gini score, the higher the importance of the variable to our model.</p>
<p>Estimate crop probabilities and map using RF. We will later use the probabilities in a conditional/markov random fields (CRFs/MRFs) classification framework which considers spatial context.</p>
<pre class="r"><code>tic(&quot;RF mapping duration:&quot;)
rf.f.map &lt;- superClass(brick(s2h.fused), train.f, responseCol = &quot;class&quot;,
                model = &quot;rf&quot;)
toc()</code></pre>
<pre><code>## RF mapping duration:: 149.52 sec elapsed</code></pre>
<pre class="r"><code>tic(&quot;RF probabilities duration:&quot;)
rf.f.prob &lt;- superClass(brick(s2h.fused), train.f, responseCol = &quot;class&quot;,
                model = &quot;rf&quot;, predType=&quot;prob&quot;)
toc()</code></pre>
<pre><code>## RF probabilities duration:: 160.81 sec elapsed</code></pre>
<pre class="r"><code>#Display RF map.
display(rf.f.map$map, &quot;Fused RF&quot;, nClasses)</code></pre>
<p>Validate RF fused map using F1-score and compare it with MLC fusion.</p>
<pre class="r"><code>val.rf.f &lt;- validateMap(rf.f.map$map, valid.f, responseCol=&quot;code&quot;, mode=&#39;classification&#39;)

List.rf.f &lt;- accuracy(val.rf.f)
knitr::kable(data.frame(RFfused=round(List.rf.f$byClass[,&#39;F1&#39;],3),
            MLCfused=round(List.f$byClass[,&#39;F1&#39;],3)), align=&#39;l&#39;, caption = &#39;F1-score&#39;)</code></pre>
<table>
<caption>F1-score</caption>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">RFfused</th>
<th align="left">MLCfused</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: 1</td>
<td align="left">0.986</td>
<td align="left">0.976</td>
</tr>
<tr class="even">
<td align="left">Class: 2</td>
<td align="left">0.949</td>
<td align="left">0.925</td>
</tr>
<tr class="odd">
<td align="left">Class: 3</td>
<td align="left">0.857</td>
<td align="left">0.750</td>
</tr>
<tr class="even">
<td align="left">Class: 4</td>
<td align="left">0.932</td>
<td align="left">0.810</td>
</tr>
<tr class="odd">
<td align="left">Class: 5</td>
<td align="left">0.917</td>
<td align="left">0.733</td>
</tr>
<tr class="even">
<td align="left">Class: 6</td>
<td align="left">0.982</td>
<td align="left">0.975</td>
</tr>
<tr class="odd">
<td align="left">Class: 7</td>
<td align="left">0.966</td>
<td align="left">0.922</td>
</tr>
<tr class="even">
<td align="left">Class: 8</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
<p>RF gives a better accuracy on the fused product compared to MLC.</p>
</div>
</div>
<div id="mrf" class="section level2">
<h2>MRF</h2>
<p>Markov Random Fields (MRFs) and Conditional Random Fields (CRFs) techniques are one of the commonly used contextual classification methods. They offer a probabilistic framework that models spatial dependencies of labels (MRFs) with additional dependencies in data in the case of CRFs in a classified image (Kenduiywo 2016).</p>
<pre class="r"><code>#Load CRF/MRF function
source(paste0(&quot;D:/Code/Sleek/CRF_MRF.R&quot;))
WithRef     &lt;- FALSE
beta0         &lt;- 20
Nneighb     &lt;- 4
bCRF          &lt;- FALSE #If TRUE MOdel runs CRF

#Take care of NA mask
image &lt;- brick(s2h.fused)
mrf_name &lt;- paste0(Path_out,&#39;Mpolonjeni_fused_MRF_map.tif&#39;)
if(!file.exists(mrf_name)){
  rf_MRF &lt;- CRF_MRF(image, WithRef, beta0, Nneighb, rf.f.map$map, rf.f.prob$map, bCRF, nClasses)
  writeRaster(rf_MRF, mrf_name)
}else{
  rf_MRF &lt;- brick(mrf_name)
}

display(rf_MRF, &quot;Fused RF-MRF&quot;, nClasses)

val.mrf.f &lt;- validateMap(rf_MRF, valid.f, responseCol=&quot;code&quot;, mode=&#39;classification&#39;)</code></pre>
<p><img src="mapping_files/figure-html/crf1-1.png" width="672" /></p>
<pre class="r"><code>List.mrf.f &lt;- accuracy(val.mrf.f)
knitr::kable(data.frame(MRFfused=round(List.mrf.f$byClass[,&#39;F1&#39;],3),RFfused=round(List.rf.f$byClass[,&#39;F1&#39;],3),
            MLCfused=round(List.f$byClass[,&#39;F1&#39;],3)), align=&#39;l&#39;, caption = &#39;F1-score&#39;)</code></pre>
<table>
<caption>F1-score</caption>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">MRFfused</th>
<th align="left">RFfused</th>
<th align="left">MLCfused</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Class: 1</td>
<td align="left">0.995</td>
<td align="left">0.986</td>
<td align="left">0.976</td>
</tr>
<tr class="even">
<td align="left">Class: 2</td>
<td align="left">0.962</td>
<td align="left">0.949</td>
<td align="left">0.925</td>
</tr>
<tr class="odd">
<td align="left">Class: 3</td>
<td align="left">0.887</td>
<td align="left">0.857</td>
<td align="left">0.750</td>
</tr>
<tr class="even">
<td align="left">Class: 4</td>
<td align="left">0.968</td>
<td align="left">0.932</td>
<td align="left">0.810</td>
</tr>
<tr class="odd">
<td align="left">Class: 5</td>
<td align="left">0.921</td>
<td align="left">0.917</td>
<td align="left">0.733</td>
</tr>
<tr class="even">
<td align="left">Class: 6</td>
<td align="left">0.992</td>
<td align="left">0.982</td>
<td align="left">0.975</td>
</tr>
<tr class="odd">
<td align="left">Class: 7</td>
<td align="left">0.975</td>
<td align="left">0.966</td>
<td align="left">0.922</td>
</tr>
<tr class="even">
<td align="left">Class: 8</td>
<td align="left">0.996</td>
<td align="left">1.000</td>
<td align="left">1.000</td>
</tr>
</tbody>
</table>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Breiman, L. Random Forests. <em>Machine Learning</em> 45, 5–32 (2001). <a href="https://doi.org/10.1023/A:1010933404324" class="uri">https://doi.org/10.1023/A:1010933404324</a></p>
<p>Y. Zou, G. Li and S. Wang, “The Fusion of Satellite and Unmanned Aerial Vehicle (UAV) Imagery for Improving Classification Performance,” <em>IEEE International Conference on Information and Automation (ICIA)</em>, 2018, pp. 836-841, doi: 10.1109/ICInfA.2018.8812312.</p>
<p>Kenduiywo, B. <em>Spatial-temporal Dynamic Conditional Random Fields crop type mapping using radar images</em>. Technische Universitaet Darmstadt Prints (2016)</p>
</div>

<p> Created 14th May 2021 Copyright &copy; Benson Kenduiywo, Inc. All rights reserved.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
