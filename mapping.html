<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Crop mapping</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Digital Image Processing in R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-gear"></span>
     
    More
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lesson1.html">Data storage schema</a>
    </li>
    <li>
      <a href="fusion.html">Image Fusion</a>
    </li>
    <li>
      <a href="mapping.html">Crop mapping</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:bensonkemboi@gmail.com">
    <span class="fas fa-envelope fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://github.com/bensonkenduiywo">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/bensonkenduiywo">
    <span class="fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/benson-kenduiywo-1a218137">
    <span class="fab fa-linkedin fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Crop mapping</h1>

</div>


<div id="background" class="section level2">
<h2>Background</h2>
<p>Information on spatial distribution of crops is an important step towards yield estimation. We need to know where the crops are before we estimate the yield in a given region. Ground mapping approaches like surveying are expensive and time intensive. Remote sensing offers an effective and efficient platform for mapping thanks to improved temporal and spatial resolutions. In this case we supplement optical data with UAV images for training sites collection, and image fusion for crop mapping.</p>
<p>For crop mapping we use two different classification algorithms:</p>
<ol style="list-style-type: decimal">
<li>Random Forests (RF) by <a href="https://link.springer.com/article/10.1023/A:1010933404324">Breiman 2001</a>.</li>
<li>Maximum Likelihood Classification (MLC).</li>
</ol>
</div>
<div id="data-preparation" class="section level2">
<h2>Data preparation</h2>
<p>Load libraries, declare variables and data paths.</p>
<pre class="r"><code>rm(list=ls(all=TRUE))    #Clears R memory
unlink(&quot;.RData&quot;) 
if (!require(&quot;pacman&quot;)) install.packages(&quot;pacman&quot;); library(pacman)
p_load(raster, terra, randomForest,RStoolbox)

options(warn=1)
cat(&quot;Set variables and start processing\n&quot;)</code></pre>
<pre><code>## Set variables and start processing</code></pre>
<pre class="r"><code>Root        &lt;- &#39;D:/JKUAT/RESEARCH_Projects/Eswatini/Data/&#39;
Path_out    &lt;- paste0(Root,&quot;Output/&quot;)</code></pre>
<p>Load Mpolonjeni UAV images for mission 1–5 and Sentinel 2. We will mosaic the UAV images to one image at 1 m spatial resolution and save to disk later. Once this is done we skip this process every other time we ru the script.</p>
<pre class="r"><code>#Sentinel 2
path &lt;- list.files(paste0(Root,&#39;S2/interim/&#39;),pattern = (&quot;.tif$&quot;), recursive = TRUE, full.names = TRUE)
s &lt;- rast(path)
names(s) &lt;- c(&quot;b&quot;, &quot;g&quot;,&quot;r&quot;, &quot;nir&quot;)
s</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 10980, 10980, 4  (nrow, ncol, nlyr)
## resolution  : 10, 10  (x, y)
## extent      : 3e+05, 409800, 6990220, 7100020  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=utm +zone=36 +south +datum=WGS84 +units=m +no_defs 
## sources     : RT_T36JUR_20210418T073611_B02.tif  
##               RT_T36JUR_20210418T073611_B03.tif  
##               RT_T36JUR_20210418T073611_B04.tif  
##               ... and 1 more source(s)
## names       : b, g, r, nir</code></pre>
<pre class="r"><code>#UAV
mosaicname &lt;- paste0(Path_out,&#39;Mpolonjeni_W1_Mosaic.tif&#39;)
if(!file.exists(mosaicname)){
folders &lt;- list.dirs(paste0(Root,&#39;WingtraOne/Mpolonjeni&#39;),recursive=TRUE)[-1]
folders 
for (i in 1:length(folders)) {
  path &lt;- list.files(folders[i], pattern = (&quot;.tif$&quot;))
  # Remove all before and up to &quot;reflectance_&quot; in gsub
  path &lt;- path[order(gsub(&quot;.*reflectance_&quot;,&quot;&quot;,path))][-4]
  #reorder the bands to match those in S2
  paths &lt;- path
  paths[3] &lt;- path[4]
  paths[4] &lt;- path[3]
  temp &lt;- rast(paste0(folders[i],&quot;/&quot;,paths))
  names(temp) &lt;- c(&quot;b&quot;, &quot;g&quot;, &quot;r&quot;, &quot;nir&quot;)
  assign(paste0(&quot;v&quot;, i), temp) 
}
}else{
  v &lt;- rast(mosaicname)
}</code></pre>
<p>We now have all the image missions loaded from corresponding sub-folders, stacked, and dynamically allocated variables i.e. <span class="math inline">\(\text{v1},\text{v2},\dots,\text{v5}\)</span>. Resample all the images to 1 m spatial resolution using bilinear approach and mosaic them.</p>
<pre class="r"><code>if(!file.exists(mosaicname)){
  temp &lt;- aggregate(v1[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v1 &lt;- resample(v1, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v2[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v2 &lt;- resample(v2, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v3[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v3 &lt;- resample(v3, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v4[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v4 &lt;- resample(v4, temp, method=&#39;bilinear&#39;)
  temp &lt;- aggregate(v5[[1]], 9)
  res(temp) &lt;- c(1, 1)
  v5 &lt;- resample(v5, temp, method=&#39;bilinear&#39;)
}</code></pre>
<p>Let’s now mosaic the scenes to form one image. We will use median to average out the overlaps. Median is preferred because it has been shown to be robust to outliers compared to the mean.</p>
<pre class="r"><code>if(!file.exists(mosaicname)){
  v &lt;- mosaic(v1, v2, v3, v4, v5, fun=&quot;median&quot;)
}</code></pre>
<p>Save the mosaic to disk.</p>
<pre class="r"><code>mosaicname &lt;- paste0(Path_out,&#39;Mpolonjeni_W1_Mosaic.tif&#39;)
if(!file.exists(mosaicname)){
  writeRaster(v, mosaicname)    
}</code></pre>
<p>Crop/clip Sentinel 2 image to UAV image extents.</p>
<pre class="r"><code>s &lt;- crop(s, ext(v), snap=&quot;near&quot;)</code></pre>
<p>Display the images side by side.</p>
<pre class="r"><code>x11()
par(mfrow = c(1, 2)) #c(bottom, left, top, right)
plotRGB(s, r=&quot;nir&quot;, g=&quot;r&quot;, b=&quot;g&quot;, stretch=&quot;lin&quot;, axes=T, mar = c(4, 5, 1.4, 0.2), main=&quot;S2&quot;, cex.axis=0.5)
box()
plotRGB(v, r=&quot;nir&quot;, g=&quot;r&quot;, b=&quot;g&quot;, stretch=&quot;lin&quot;, axes=T, mar = c(4, 5, 1.4, 0.2), main=&quot;UAV&quot;, cex.axis=0.5)
box()</code></pre>
<p><img src="mapping_files/figure-html/d7-1.png" width="672" /></p>
</div>
<div id="training-data-sampling" class="section level2">
<h2>Training data sampling</h2>
<p>Load train data.</p>
<pre class="r"><code>#ref &lt;- vect(paste0(Root,&#39;Vector/Training_Sites_Mpolonjeni.shp&#39;), &quot;polygons&quot;)
ref  &lt;- shapefile(paste0(Root,&#39;Vector/Training_Sites_Mpolonjeni.shp&#39;))</code></pre>
<p>Sample points from the polygons (stratified random sampling).</p>
<pre class="r"><code>set.seed(530)
samp &lt;- spsample(ref, 4000, type=&#39;stratified&#39;)</code></pre>
<pre><code>## Warning in proj4string(obj): CRS object has comment, which is lost in output</code></pre>
<pre class="r"><code># add the land cover class to the points
samp$class &lt;- over(samp, ref)$Name
table(samp$class)</code></pre>
<pre><code>## 
##     built_up      cassava        grass        maize      sorghum sweet_potato 
##          736          107          144          715          229          729 
##        trees    waterbody 
##          967          353</code></pre>
<pre class="r"><code>sort(unique(samp$class))</code></pre>
<pre><code>## [1] &quot;built_up&quot;     &quot;cassava&quot;      &quot;grass&quot;        &quot;maize&quot;        &quot;sorghum&quot;     
## [6] &quot;sweet_potato&quot; &quot;trees&quot;        &quot;waterbody&quot;</code></pre>
<pre class="r"><code>sum(table(samp$class))</code></pre>
<pre><code>## [1] 3980</code></pre>
<p>Transform samples to coordinates of the image.</p>
<pre class="r"><code>samp &lt;- spTransform(samp, crs(s))
nClasses &lt;- 8
Classes &lt;- data.frame(classID=c(1:8),class=c(&#39;Built_up&#39;,&#39;Cassava&#39;, &#39;Grass&#39;, 
&#39;Maize&#39;,  &#39;Sorghum&#39;, &#39;Sweet_potato&#39;,&#39;Trees&#39;,&#39;Water&#39;))</code></pre>
<p>Display S2 image and the training points.</p>
<pre class="r"><code>add_legend &lt;- function(...) {
  opar &lt;- par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), 
    mar=c(0, 0, 0, 0), new=TRUE)
  on.exit(par(opar))
  plot(0, 0, type=&#39;n&#39;, bty=&#39;n&#39;, xaxt=&#39;n&#39;, yaxt=&#39;n&#39;)
  legend(...)
}

x11()
#par(mar = c(4, 4, 1.4, 0.1)) #c(bottom, left, top, right)
plotRGB(s, r=&quot;nir&quot;, g=&quot;r&quot;, b=&quot;g&quot;, stretch=&quot;lin&quot;, axes = TRUE, mar = c(4, 5, 1.4, 0.1))
#points(samp, col=&quot;blue&quot;, cex=.5)
lines(spTransform(ref, crs(s)), col=&quot;blue&quot;, lwd=1.5)
add_legend(&quot;bottom&quot;, legend=&quot;Reference data&quot;, 
pch=c(0,15), col=&quot;blue&quot;, horiz=T, bty=&#39;n&#39;, cex=1.1)</code></pre>
<p><img src="mapping_files/figure-html/v4-1.png" width="672" /></p>
<p>Extract UAV and S2 pixels values overlaid by points and split them into training and validation points.</p>
<pre class="r"><code>trainData.v &lt;- extract(brick(v), samp, cellnumbers=F, df=T, sp=T) 
head(trainData.v)</code></pre>
<pre><code>##       class          b          g          r        nir
## 1 waterbody 0.06256156 0.09644703 0.09899782 0.08365054
## 2 waterbody 0.06439328 0.09717349 0.10095690 0.08490235
## 3 waterbody 0.06439328 0.09717349 0.10095690 0.08490235
## 4 waterbody 0.06425814 0.09694316 0.10035420 0.08650444
## 5 waterbody 0.06456918 0.09819815 0.10220221 0.08649202
## 6 waterbody 0.06425814 0.09694316 0.10035420 0.08650444</code></pre>
<pre class="r"><code>trainData.s &lt;- extract(brick(s), samp, cellnumbers=F, df=T, sp=T) 
head(trainData.s)</code></pre>
<pre><code>##       class          b      g     r    nir
## 1 waterbody 0.02279999 0.0253 0.024 0.0227
## 2 waterbody 0.02279999 0.0253 0.024 0.0227
## 3 waterbody 0.02279999 0.0253 0.024 0.0227
## 4 waterbody 0.02279999 0.0253 0.024 0.0227
## 5 waterbody 0.02279999 0.0253 0.024 0.0227
## 6 waterbody 0.02279999 0.0253 0.024 0.0227</code></pre>
<pre class="r"><code>library(caTools)
#(NB: 0.4 means 40% for training and 60% for validation)
labels &lt;- as.data.frame(trainData.v[,1])
split &lt;- sample.split(labels, SplitRatio = 0.4)
#UAV
valid.v &lt;- subset(trainData.v, split == FALSE) 
train.v &lt;- subset(trainData.v, split == TRUE) 
table(train.v$class)</code></pre>
<pre><code>## 
##     built_up      cassava        grass        maize      sorghum sweet_potato 
##          248           35           46          240           75          244 
##        trees    waterbody 
##          321          118</code></pre>
<pre class="r"><code>table(valid.v$class)</code></pre>
<pre><code>## 
##     built_up      cassava        grass        maize      sorghum sweet_potato 
##          488           72           98          475          154          485 
##        trees    waterbody 
##          646          235</code></pre>
<pre class="r"><code>#Sentinel 2
valid.s &lt;- subset(trainData.s, split == FALSE) 
train.s &lt;- subset(trainData.s, split == TRUE) 
table(train.s$class)</code></pre>
<pre><code>## 
##     built_up      cassava        grass        maize      sorghum sweet_potato 
##          248           35           46          240           75          244 
##        trees    waterbody 
##          321          118</code></pre>
<pre class="r"><code>table(valid.s$class)</code></pre>
<pre><code>## 
##     built_up      cassava        grass        maize      sorghum sweet_potato 
##          488           72           98          475          154          485 
##        trees    waterbody 
##          646          235</code></pre>
</div>
<div id="maximum-likelihood-classification" class="section level2">
<h2>Maximum Likelihood Classification</h2>
<p>Classify UAV and S2 image using MLC algorithm.</p>
<pre class="r"><code>#UAV classification
mlc.uav &lt;- superClass(brick(v), train.v, responseCol = &quot;class&quot;,
                model = &quot;mlc&quot;, minDist = 1)
val.uav &lt;- validateMap(mlc.uav$map, valid.v, responseCol=&quot;class&quot;, mode=&#39;classification&#39;, 
classMapping = mlc.uav$classMapping)
#Sentinel 2 classification
mlc.s &lt;- superClass(brick(s), train.s, responseCol = &quot;class&quot;,
                model = &quot;mlc&quot;, minDist = 1)
val.s &lt;- validateMap(mlc.s$map, valid.s, responseCol=&quot;class&quot;, mode=&#39;classification&#39;, 
classMapping = mlc.s$classMapping)</code></pre>
<p>Make a function to display classified images and use it to display the MLC map.</p>
<pre class="r"><code>display &lt;- function(map, method, nClasses){
    x11()
    par(mar = c(7, 2, 1.6, 6)) #c(bottom, left, top, right)
    image(map, col=c(&quot;magenta&quot;, &quot;darkgreen&quot;, &quot;seagreen1&quot; , &quot;yellow&quot;, &quot;darkseagreen&quot;, &quot;green1&quot;,
    &quot;cyan&quot;,&quot;blue&quot;), axes=T, ann=F)
    classes.Palette &lt;- colorRampPalette(c(&quot;magenta&quot;, &quot;darkgreen&quot;, &quot;seagreen1&quot; , &quot;yellow&quot;, &quot;darkseagreen&quot;, &quot;green1&quot;,
    &quot;cyan&quot;,&quot;blue&quot;, &quot;white&quot;)) 
    add_legend(&quot;bottom&quot;, legend=c(&#39;Built_up&#39;,&#39;Cassava&#39;, &#39;Grass&#39;, 
&#39;Maize&#39;,  &#39;Sorghum&#39;, &#39;Sweet_potato&#39;,&#39;Trees&#39;,&#39;Water&#39;, &quot;No data&quot;), fill=classes.Palette(nClasses+1), ncol=3, bty=&#39;n&#39;, cex=1.1,  pt.bg = NA)
    title(paste0(method,&quot; Classification&quot;))
}
mlc.disp.v &lt;- display(mlc.uav$map, &quot;UAV MLC&quot;, nClasses)
mlc.disp.s &lt;- display(mlc.s$map, &quot;S2 MLC&quot;, nClasses)

mlc.disp.v</code></pre>
<p><img src="mapping_files/figure-html/disp-1.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<pre class="r"><code>mlc.disp.s</code></pre>
<pre><code>## NULL</code></pre>
<p>Lets design a function for accuracy assessment.</p>
<pre class="r"><code>accuracy &lt;- function(val.test){
    assessment.storage &lt;- val.test$performance 
    #print(assessment.storage)
    list_of_datasets &lt;- list(&quot;ConfusionMatrix&quot; = as.matrix(assessment.storage$table), 
                    &quot;OverallAcc&quot; = as.matrix(assessment.storage$overall), 
                    &quot;byClass&quot; = as.matrix(assessment.storage$byClass))
    return(list_of_datasets)
}</code></pre>
<p>Assess the accuracy of MLC.</p>
<pre class="r"><code>print(&#39;UAV Confusion matrixs&#39;)</code></pre>
<pre><code>## [1] &quot;UAV Confusion matrixs&quot;</code></pre>
<pre class="r"><code>List.v &lt;- accuracy(val.uav)
List.v$ConfusionMatrix</code></pre>
<pre><code>##               Reference
## Prediction     built_up cassava grass maize sorghum sweet_potato trees
##   built_up          274       0     0     0       0            0     1
##   cassava             0      41     0     0       0            0     0
##   grass               0       0    58    20       0            0     6
##   maize              10       0     2   213       3            0    11
##   sorghum             0       0     0     8      80            0     2
##   sweet_potato        0       1     0     0       0          237     1
##   trees               0       0     3     0       0            3   328
##   waterbody           0       0     0     0       0            0     0
##               Reference
## Prediction     waterbody
##   built_up             0
##   cassava              0
##   grass                0
##   maize                4
##   sorghum              0
##   sweet_potato         0
##   trees                0
##   waterbody          107</code></pre>
<pre class="r"><code>print(&#39;S2 Confusion matrixs&#39;)</code></pre>
<pre><code>## [1] &quot;S2 Confusion matrixs&quot;</code></pre>
<pre class="r"><code>List.s &lt;- accuracy(val.s)
List.s$ConfusionMatrix</code></pre>
<pre><code>##               Reference
## Prediction     built_up cassava grass maize sorghum sweet_potato trees
##   built_up           70       0     0     1       0            0     2
##   cassava             0       9     0     0       0            0     0
##   grass               4       0     8     4       0            0     1
##   maize               7       0    15    28       1            0     9
##   sorghum             2       0     1     4       8            0     4
##   sweet_potato        0       0     0     0       0           14     2
##   trees               0       0     0     1       0            0   115
##   waterbody           0       0     0     0       0            0     0
##               Reference
## Prediction     waterbody
##   built_up             0
##   cassava              0
##   grass                0
##   maize                0
##   sorghum              0
##   sweet_potato         0
##   trees                0
##   waterbody            8</code></pre>
<pre class="r"><code>print(&#39;Other accuracy measures&#39;)</code></pre>
<pre><code>## [1] &quot;Other accuracy measures&quot;</code></pre>
<pre class="r"><code>data.frame(Type=List.v$OverallAcc[,0], UAV=round(List.v$OverallAcc[,1],3),S2=round(List.s$OverallAcc[,1],3))</code></pre>
<pre><code>##                  UAV    S2
## Accuracy       0.947 0.818
## Kappa          0.936 0.759
## AccuracyLower  0.934 0.771
## AccuracyUpper  0.958 0.858
## AccuracyNull   0.247 0.418
## AccuracyPValue 0.000 0.000
## McnemarPValue    NaN   NaN</code></pre>
<pre class="r"><code>data.frame(UAV_F1score=round(List.v$byClass[,&#39;F1&#39;],3),S2_F1score=round(List.s$byClass[,&#39;F1&#39;],3))</code></pre>
<pre><code>##                     UAV_F1score S2_F1score
## Class: built_up           0.980      0.897
## Class: cassava            0.988      1.000
## Class: grass              0.789      0.390
## Class: maize              0.880      0.571
## Class: sorghum            0.925      0.571
## Class: sweet_potato       0.990      0.933
## Class: trees              0.960      0.924
## Class: waterbody          0.982      1.000</code></pre>
<pre class="r"><code>data.frame(UAV_UserAcc=round(List.v$byClass[,&#39;Precision&#39;],3),S2_UserAcc=round(List.s$byClass[,&#39;Precision&#39;],3))</code></pre>
<pre><code>##                     UAV_UserAcc S2_UserAcc
## Class: built_up           0.996      0.959
## Class: cassava            1.000      1.000
## Class: grass              0.690      0.471
## Class: maize              0.877      0.467
## Class: sorghum            0.889      0.421
## Class: sweet_potato       0.992      0.875
## Class: trees              0.982      0.991
## Class: waterbody          1.000      1.000</code></pre>
<pre class="r"><code>data.frame(UAV_ProducerAcc=round(List.v$byClass[,&#39;Sensitivity&#39;],3),S2_ProducerAcc=round(List.s$byClass[,&#39;Sensitivity&#39;],3))</code></pre>
<pre><code>##                     UAV_ProducerAcc S2_ProducerAcc
## Class: built_up               0.965          0.843
## Class: cassava                0.976          1.000
## Class: grass                  0.921          0.333
## Class: maize                  0.884          0.737
## Class: sorghum                0.964          0.889
## Class: sweet_potato           0.988          1.000
## Class: trees                  0.940          0.865
## Class: waterbody              0.964          1.000</code></pre>
<p>Generally UAV gives better accuracy in most classes except for cassava and water where Sentinel 2 performs well as observed from F1-score. However, the big question is will fusion improve accuracy? Let’s consider a Zhou’s fusion approach using random forest predicted/simulated high Sentinel based donwsampled Sentinel 2 data and UAV.</p>
<p>Downsample S2 to UAV 1 m spatial resolution using bilinear.</p>
<pre class="r"><code>s_r &lt;- resample(s,v,method=&quot;bilinear&quot;)</code></pre>
<p>Now sample points from UAV MLC land-cover RF regression prediction.</p>
<pre class="r"><code>set.seed(530)
points &lt;- spatSample(rast(mlc.uav$map), 3000, &quot;stratified&quot;, as.points=T, na.rm=T, values=F)</code></pre>
<p>Use the stratified randomly sample points to train and predict simulated high resolution S2.</p>
<pre class="r"><code>s2_p &lt;- extract(s, points, drop=F)
head(s2_p)</code></pre>
<pre><code>##   ID          b          g      r    nir
## 1  1 0.04029999 0.06169999 0.0564 0.2464
## 2  2 0.02719999 0.04130000 0.0303 0.2622
## 3  3 0.02870000 0.03980000 0.0301 0.2559
## 4  4 0.03450000 0.05069999 0.0497 0.2287
## 5  5 0.03920000 0.05949999 0.0633 0.2364
## 6  6 0.03960000 0.05729999 0.0643 0.2399</code></pre>
<pre class="r"><code>vr_p &lt;- extract(v, points, drop=F)
head(vr_p)</code></pre>
<pre><code>##   ID          b          g          r       nir
## 1  1 0.22268811 0.37329909 0.28506446 2.9043691
## 2  2 0.08525706 0.11527783 0.08618615 1.2984504
## 3  3 0.04848370 0.05874164 0.04805537 0.6412777
## 4  4 0.02903999 0.03692298 0.02640304 0.5202775
## 5  5 0.04280442 0.06025108 0.06453837 0.4539916
## 6  6 0.04797903 0.06185437 0.08071577 0.4839757</code></pre>
<pre class="r"><code>data &lt;- data.frame(S2=s2_p[,-1], UAV=vr_p[,-1])
library(randomForest)
#S2 predicted high resolution output name
s2h_name &lt;- paste0(Path_out,&#39;Mpolonjeni_S2_higres_Prediction.tif&#39;)
if(!file.exists(s2h_name)){
  UAV &lt;- rast(mosaicname)
  names(UAV) &lt;- c(&quot;UAV.b&quot;, &quot;UAV.g&quot;, &quot;UAV.r&quot;, &quot;UAV.nir&quot;)
  startTime &lt;- Sys.time() 
  cat(&quot;Start time&quot;, format(startTime),&quot;\n&quot;)
    s2h.b &lt;- predict(UAV, randomForest(S2.b~UAV.b, data=data), na.rm=T)
    s2h.g &lt;- predict(UAV, randomForest(S2.g~UAV.g, data=data), na.rm=T)
    s2h.r &lt;- predict(UAV, randomForest(S2.r~UAV.r, data=data), na.rm=T)
    s2h.nir &lt;- predict(UAV, randomForest(S2.nir~UAV.nir, data=data), na.rm=T)
  timeDiff &lt;- Sys.time() - startTime
  cat(&quot;\n Processing time&quot;, format(timeDiff), &quot;\n&quot;)
}</code></pre>
<p>Stack all the S2 bands predictions.</p>
<pre class="r"><code>if(!file.exists(s2h_name)){
  #Stack them
  s2h &lt;- c(s2h.b,s2h.g,s2h.r,s2h.nir)
  names(s2h) &lt;- c(&quot;b&quot;, &quot;g&quot;,&quot;r&quot;, &quot;nir&quot;)
  s2h
  writeRaster(s2h, s2h_name)    
}else{
  s2h &lt;- rast(s2h_name)
}</code></pre>
<p>Fuse the simulated S2 high resolution image with UAV using median.</p>
<pre class="r"><code>s2h.fused &lt;- mean(s2h, v)
s2h.fused</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 3228, 2572, 4  (nrow, ncol, nlyr)
## resolution  : 1, 1  (x, y)
## extent      : 388657.1, 391229.1, 7070057, 7073285  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=utm +zone=36 +south +datum=WGS84 +units=m +no_defs 
## source      : memory 
## names       :          b,          g,          r,        nir 
## min values  : 0.01559810, 0.02113883, 0.01805469, 0.04680591 
## max values  :  0.6946765,  0.9916879,  1.1914342,  4.2903120</code></pre>
<p>Classify and validate the fused product using MLC.</p>
<pre class="r"><code>trainData.f &lt;- extract(brick(s2h.fused), samp, cellnumbers=F, df=T, sp=T) 
head(trainData.f)</code></pre>
<pre><code>##       class          b          g          r        nir
## 1 waterbody 0.05148566 0.07174089 0.08392184 0.06202933
## 2 waterbody 0.05252065 0.07593589 0.07918883 0.06892165
## 3 waterbody 0.05252065 0.07593589 0.07918883 0.06892165
## 4 waterbody 0.05244239 0.06607493 0.07917628 0.06993762
## 5 waterbody 0.04930684 0.07292266 0.07878251 0.06993141
## 6 waterbody 0.05244239 0.06607493 0.07917628 0.06993762</code></pre>
<pre class="r"><code>valid.f &lt;- subset(trainData.f, split == FALSE) 
train.f &lt;- subset(trainData.f, split == TRUE) 

mlc.f &lt;- superClass(brick(s2h.fused), train.f, responseCol = &quot;class&quot;,
                model = &quot;mlc&quot;, minDist = 1)
val.f &lt;- validateMap(mlc.f$map, valid.f, responseCol=&quot;class&quot;, mode=&#39;classification&#39;, 
classMapping = mlc.f$classMapping)

mlc.disp.f &lt;- display(mlc.f$map, &quot;S2 MLC&quot;, nClasses)

mlc.disp.f</code></pre>
<p><img src="mapping_files/figure-html/f6-1.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p>Validate the fused land-cover product.</p>
<pre class="r"><code>List.f &lt;- accuracy(val.f)
print(&#39;Accuracy measures comparison&#39;)</code></pre>
<pre><code>## [1] &quot;Accuracy measures comparison&quot;</code></pre>
<pre class="r"><code>data.frame(Type=List.v$OverallAcc[,0], UAV=round(List.v$OverallAcc[,1],3),S2=round(List.s$OverallAcc[,1],3),Fused=round(List.f$OverallAcc[,1],3))</code></pre>
<pre><code>##                  UAV    S2 Fused
## Accuracy       0.947 0.818 0.911
## Kappa          0.936 0.759 0.893
## AccuracyLower  0.934 0.771 0.895
## AccuracyUpper  0.958 0.858 0.925
## AccuracyNull   0.247 0.418 0.247
## AccuracyPValue 0.000 0.000 0.000
## McnemarPValue    NaN   NaN   NaN</code></pre>
<pre class="r"><code>data.frame(UAV_F1score=round(List.v$byClass[,&#39;F1&#39;],3),S2_F1score=round(List.s$byClass[,&#39;F1&#39;],3),Fused_F1score=round(List.f$byClass[,&#39;F1&#39;],3))</code></pre>
<pre><code>##                     UAV_F1score S2_F1score Fused_F1score
## Class: built_up           0.980      0.897         0.979
## Class: cassava            0.988      1.000         0.911
## Class: grass              0.789      0.390         0.763
## Class: maize              0.880      0.571         0.831
## Class: sorghum            0.925      0.571         0.786
## Class: sweet_potato       0.990      0.933         0.968
## Class: trees              0.960      0.924         0.915
## Class: waterbody          0.982      1.000         0.991</code></pre>
<pre class="r"><code>data.frame(UAV_UserAcc=round(List.v$byClass[,&#39;Precision&#39;],3),S2_UserAcc=round(List.s$byClass[,&#39;Precision&#39;],3),Fused_UserAcc=round(List.f$byClass[,&#39;Precision&#39;],3))</code></pre>
<pre><code>##                     UAV_UserAcc S2_UserAcc Fused_UserAcc
## Class: built_up           0.996      0.959         0.989
## Class: cassava            1.000      1.000         0.854
## Class: grass              0.690      0.471         0.652
## Class: maize              0.877      0.467         0.848
## Class: sorghum            0.889      0.421         0.669
## Class: sweet_potato       0.992      0.875         0.983
## Class: trees              0.982      0.991         0.977
## Class: waterbody          1.000      1.000         1.000</code></pre>
<pre class="r"><code>data.frame(UAV_ProducerAcc=round(List.v$byClass[,&#39;Sensitivity&#39;],3),S2_ProducerAcc=round(List.s$byClass[,&#39;Sensitivity&#39;],3), Fused_ProducerAcc=round(List.f$byClass[,&#39;Sensitivity&#39;],3))</code></pre>
<pre><code>##                     UAV_ProducerAcc S2_ProducerAcc Fused_ProducerAcc
## Class: built_up               0.965          0.843             0.968
## Class: cassava                0.976          1.000             0.976
## Class: grass                  0.921          0.333             0.921
## Class: maize                  0.884          0.737             0.813
## Class: sorghum                0.964          0.889             0.952
## Class: sweet_potato           0.988          1.000             0.954
## Class: trees                  0.940          0.865             0.860
## Class: waterbody              0.964          1.000             0.982</code></pre>
<p>It is clear that fusion improved the accuracy of Sentinel 2 classification but UAV still retained the highest accuracy. Do we probably need a better framework to reap the benefits fo fusion?</p>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Breiman, L. Random Forests. <em>Machine Learning</em> 45, 5–32 (2001). <a href="https://doi.org/10.1023/A:1010933404324" class="uri">https://doi.org/10.1023/A:1010933404324</a></p>
<p>Y. Zou, G. Li and S. Wang, “The Fusion of Satellite and Unmanned Aerial Vehicle (UAV) Imagery for Improving Classification Performance,” <em>IEEE International Conference on Information and Automation (ICIA)</em>, 2018, pp. 836-841, doi: 10.1109/ICInfA.2018.8812312.</p>
</div>

<p> Created 14th May 2021 Copyright &copy; Benson Kenduiywo, Inc. All rights reserved.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
